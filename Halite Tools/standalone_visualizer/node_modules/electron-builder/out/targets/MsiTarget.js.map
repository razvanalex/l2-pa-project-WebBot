{"version":3,"file":"MsiTarget.js","sourceRoot":"","sources":["../../src/targets/MsiTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import { Target } from \"../core\"\nimport { WinPackager } from \"../winPackager\"\nimport { Arch, warn } from \"builder-util\"\nimport { readFile, writeFile } from \"fs-extra-p\"\nimport { getTemplatePath } from \"../util/pathManager\"\nimport * as path from \"path\"\nimport { deepAssign } from \"read-config-file/out/deepAssign\"\nimport { createHelperDir } from \"./targetUtil\"\nimport { MsiOptions } from \"../\"\nimport { UUID } from \"builder-util-runtime\"\nimport BluebirdPromise from \"bluebird-lst\"\nimport { walk } from \"builder-util/out/fs\"\nimport { createHash } from \"crypto\"\n\nconst ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID = UUID.parse(\"d752fe43-5d44-44d5-9fc9-6dd1bf19d5cc\")\nconst ELECTRON_BUILDER_COMPONENT_KEY_PATH_NS_UUID = UUID.parse(\"a1fd0bba-2e5e-48dd-8b0e-caa943b1b0c9\")\nconst ROOT_DIR_ID = \"APPLICATIONFOLDER\"\n\nexport default class MsiTarget extends Target {\n  readonly options: MsiOptions = deepAssign({\n    perMachine: true,\n  }, this.packager.platformSpecificBuildOptions, this.packager.config.msi)\n\n  constructor(private readonly packager: WinPackager, readonly outDir: string) {\n    super(\"msi\")\n  }\n\n  async build(appOutDir: string, arch: Arch) {\n    const packager = this.packager\n    const vm = await packager.vm.value\n\n    const stageDir = await createHelperDir(this, arch)\n\n    const projectFile = stageDir.getTempFile(\"project.wxs\")\n    const objectFile = stageDir.getTempFile(\"project.wixobj\")\n    await writeFile(projectFile, await this.writeManifest(getTemplatePath(\"msi\"), appOutDir, arch))\n\n    // const vendorPath = \"/Users/develar/Library/Caches/electron-builder/wix\"\n    const vendorPath = \"C:\\\\Program Files (x86)\\\\WiX Toolset v4.0\\\\bin\"\n\n    const candleArgs = [\n      \"-arch\", arch === Arch.ia32 ? \"x86\" : (arch === Arch.armv7l ? \"arm\" : \"x64\"),\n      \"-out\", vm.toVmFile(objectFile),\n      `-dappDir=${\"C:\\\\Users\\\\develar\\\\win-unpacked\"}`,\n      \"-pedantic\",\n    ]\n    if (this.options.warningsAsErrors !== false) {\n      candleArgs.push(\"-wx\")\n    }\n    candleArgs.push(vm.toVmFile(projectFile))\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"candle.exe\")), candleArgs)\n\n    const artifactName = packager.expandArtifactNamePattern(this.options, \"msi\", arch)\n    const artifactPath = path.join(this.outDir, artifactName)\n\n    // noinspection SpellCheckingInspection\n    const lightArgs = [\n      \"-out\", vm.toVmFile(artifactPath),\n      \"-pedantic\",\n      \"-v\",\n      // https://github.com/wixtoolset/issues/issues/5169\n      \"-spdb\",\n      `-dappDir=${\"C:\\\\Users\\\\develar\\\\win-unpacked\"}`,\n      // \"-b\", \"Z:\\\\Volumes\\\\test\\\\electron-builder-test\\\\dist\\\\win-unpacked\" || vm.toVmFile(appOutDir),\n    ]\n    if (this.options.warningsAsErrors !== false) {\n      lightArgs.push(\"-wx\")\n    }\n\n    if (this.options.oneClick === false) {\n      // lightArgs.push(\"-ext\", vm.toVmFile(path.join(vendorPath, \"WixUIExtension.dll\")))\n      lightArgs.push(\"-ext\", \"WixUIExtension\")\n    }\n\n    lightArgs.push(vm.toVmFile(objectFile))\n    await vm.exec(vm.toVmFile(path.join(vendorPath, \"light.exe\")), lightArgs)\n\n    await stageDir.cleanup()\n\n    packager.info.dispatchArtifactCreated({\n      file: artifactPath,\n      packager,\n      arch,\n      safeArtifactName: packager.computeSafeArtifactName(artifactName, \"msi\"),\n      target: this,\n      isWriteUpdateInfo: false,\n    })\n  }\n\n  private async writeManifest(templatePath: string, appOutDir: string, arch: Arch) {\n    const appInfo = this.packager.appInfo\n    const registryKeyPathId = UUID.v5(appInfo.id, ELECTRON_BUILDER_COMPONENT_KEY_PATH_NS_UUID)\n\n    const dirNames = new Set<string>()\n    let dirs = \"\"\n    const fileSpace = \" \".repeat(6)\n\n    let isRootDirAddedToRemoveTable = false\n\n    const files = await BluebirdPromise.map(walk(appOutDir), file => {\n      let packagePath = file.substring(appOutDir.length + 1)\n      if (path.sep !== \"\\\\\") {\n        packagePath = packagePath.replace(/\\//g, \"\\\\\")\n      }\n\n      let isAddRemoveFolder = false\n\n      const lastSlash = packagePath.lastIndexOf(\"\\\\\")\n      const fileName = lastSlash > 0 ? packagePath.substring(lastSlash + 1) : packagePath\n      let directoryId: string | null = null\n      let dirName = \"\"\n      // Wix Directory.FileSource doesn't work - https://stackoverflow.com/questions/21519388/wix-filesource-confusion\n      if (lastSlash > 0) {\n        // This Name attribute may also define multiple directories using the inline directory syntax.\n        // For example, \"ProgramFilesFolder:\\My Company\\My Product\\bin\" would create a reference to a Directory element with Id=\"ProgramFilesFolder\" then create directories named \"My Company\" then \"My Product\" then \"bin\" nested beneath each other.\n        // This syntax is a shortcut to defining each directory in an individual Directory element.\n        dirName = packagePath.substring(0, lastSlash)\n        // add U (user) suffix just to be sure that will be not overwrite system WIX directory ids.\n        directoryId = `${dirName.toLowerCase()}_u`\n        if (!dirNames.has(dirName)) {\n          isAddRemoveFolder = true\n          dirNames.add(dirName)\n          dirs += `    <Directory Id=\"${directoryId}\" Name=\"${ROOT_DIR_ID}:\\\\${dirName}\\\\\"/>\\n`\n        }\n      }\n      else if (!isRootDirAddedToRemoveTable) {\n        isRootDirAddedToRemoveTable = true\n        isAddRemoveFolder = true\n      }\n\n      // since RegistryValue can be part of Component, *** *** *** *** *** *** *** *** *** wix cannot auto generate guid\n      // https://stackoverflow.com/questions/1405100/change-my-component-guid-in-wix\n      let result = `<Component${directoryId === null ? \"\" : ` Directory=\"${directoryId}\"`} Guid=\"${UUID.v5(packagePath, ELECTRON_BUILDER_COMPONENT_KEY_PATH_NS_UUID).toUpperCase()}\">`\n      if (!this.options.perMachine) {\n        // https://stackoverflow.com/questions/16119708/component-testcomp-installs-to-user-profile-it-must-use-a-registry-key-under-hk\n        result += `\\n${fileSpace}  <RegistryValue Root=\"HKCU\" Key=\"Software\\\\${registryKeyPathId}\" Name=\"${packagePath}\" Value=\"${appInfo.version}\" Type=\"string\" KeyPath=\"yes\"/>`\n        if (isAddRemoveFolder) {\n          // https://stackoverflow.com/questions/3290576/directory-xx-is-in-the-user-profile-but-is-not-listed-in-the-removefile-table\n          result += `\\n${fileSpace}  <RemoveFolder Id=\"${hashString2(dirName, packagePath)}\" On=\"uninstall\"/>`\n        }\n      }\n      // Id=\"${hashString(packagePath)}\"\n      result += `\\n${fileSpace}  <File Name=\"${fileName}\" Source=\"$(var.appDir)\\\\${packagePath}\" ReadOnly=\"yes\"`\n      if (this.options.perMachine) {\n        result += ' KeyPath=\"yes\"'\n      }\n      result += `/>\\n${fileSpace}</Component>`\n      return result\n    })\n\n    return (await readFile(path.join(templatePath, \"template.wxs\"), \"utf8\"))\n      .replace(/\\$\\{([a-zA-Z0-9]+)\\}/g, (match, p1): string => {\n        const options = this.options\n        switch (p1) {\n          // wix in the name because special wix format can be used in the name\n          case \"installationDirectoryWixName\":\n            const name = /^[-_+0-9a-zA-Z ]+$/.test(appInfo.productFilename) ? appInfo.productFilename : appInfo.sanitizedName\n            if (options.perMachine) {\n              return name\n            }\n            return `LocalAppDataFolder:\\\\Programs\\\\${name}\\\\`\n\n          case \"productName\":\n            return appInfo.productName\n\n          case \"manufacturer\":\n            const companyName = appInfo.companyName\n            if (!companyName) {\n              warn(`Manufacturer is not set for MSI â€” please set \"author\" in the package.json`)\n            }\n            return companyName || appInfo.productName\n\n          case \"upgradeCode\":\n            return (options.upgradeCode || UUID.v5(appInfo.id, ELECTRON_BUILDER_UPGRADE_CODE_NS_UUID)).toUpperCase()\n\n          case \"version\":\n            return appInfo.versionInWeirdWindowsForm\n\n          case \"compressionLevel\":\n            const compression = this.packager.compression\n            return compression === \"store\" ? \"none\" : \"high\"\n\n          case \"uiRef\":\n            return options.oneClick === false ? '<UIRef Id=\"WixUI_Advanced\" />' : \"\"\n\n          case \"dirs\":\n            return dirs\n\n          case \"files\":\n            return fileSpace + files.join(`\\n${fileSpace}`)\n\n          case \"programFilesId\":\n            if (options.perMachine) {\n              // https://stackoverflow.com/questions/1929038/compilation-error-ice80-the-64bitcomponent-uses-32bitdirectory\n              return arch === Arch.x64 ? \"ProgramFiles64Folder\" : \"ProgramFilesFolder\"\n            }\n            else {\n              return \"LocalAppDataFolder\"\n            }\n\n          default:\n            throw new Error(`Macro ${p1} is not defined`)\n        }\n      })\n  }\n}\n\n// function hashString(s: string) {\n//   const hash = createHash(\"md5\")\n//   hash.update(s)\n//   return hash.digest(\"hex\")\n// }\n\nconst nullByteBuffer = Buffer.from([0])\n\nfunction hashString2(s: string, s2: string) {\n  const hash = createHash(\"md5\")\n  hash.update(s)\n  hash.update(nullByteBuffer)\n  hash.update(s2)\n  return hash.digest(\"hex\")\n}"]}
